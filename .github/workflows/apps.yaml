name: apps
"on":
  push:
    branches: main
    paths:
      - apps/**
jobs:
  blog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - run: printf '%s' "${GOOGLE_CREDENTIALS}" > "${GOOGLE_APPLICATION_CREDENTIALS}"
        working-directory: apps/blog
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/apps/blog/application_default_credentials.json
      - name: Install SOPS
        run: |-
          mkdir -p bin/
          curl -L --output bin/sops https://github.com/mozilla/sops/releases/download/v3.7.3/sops-v3.7.3.linux.amd64
          chmod +x bin/sops
          echo "${GITHUB_WORKSPACE}/bin" >> $GITHUB_PATH
      - run: mkdir -p ~/.docker; sops -d --output ~/.docker/config.json config.enc.json
        working-directory: apps/blog
        env:
          SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
      - env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/apps/blog/application_default_credentials.json
        name: build and deploy
        run: bazel run :deployment.apply
        working-directory: apps/blog
